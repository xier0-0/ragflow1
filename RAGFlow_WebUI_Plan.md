# RAGFlow ç»Ÿä¸€ Web äº¤äº’å¹³å° â€” è®¾è®¡æ–¹æ¡ˆ

## ä¸€ã€é¡¹ç›®ç›®æ ‡

åœ¨**ä¸€ä¸ª HTML é¡µé¢**ä¸­ï¼Œæ•´åˆ RAGFlow çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·äº¤äº’ä½“éªŒï¼š

- çŸ¥è¯†åº“ç®¡ç†ï¼ˆåˆ›å»º / åˆ é™¤ / æŸ¥çœ‹ï¼‰
- æ–‡æ¡£ç®¡ç†ï¼ˆä¸Šä¼  / è§£æ / æŸ¥çœ‹çŠ¶æ€ / åˆ é™¤ï¼‰
- ä¼šè¯ç®¡ç†ï¼ˆåˆ›å»º / åˆ‡æ¢ / åˆ é™¤ï¼‰
- æ™ºèƒ½å¯¹è¯ï¼ˆæµå¼ SSE è¾“å‡º + å¼•ç”¨å±•ç¤ºï¼‰

éƒ¨ç½²æ–¹å¼ï¼šé™æ€ HTML + JSï¼ŒæŒ‚è½½åˆ° RAGFlow å®¹å™¨çš„ Nginx ä¸‹ï¼Œèµ°åŒæºè®¿é—®ï¼Œæ— éœ€é¢å¤–åç«¯ã€‚

---

## äºŒã€æŠ€æœ¯çº¦æŸ

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| åç«¯ç‰ˆæœ¬ | `infiniflow/ragflow:v0.23.1`ï¼ˆä¸å¯ä¿®æ”¹åç«¯ä»£ç ï¼‰ |
| éƒ¨ç½²æ–¹å¼ | é™æ€ HTML æŒ‚è½½åˆ° Nginxï¼ˆDocker volume bind mountï¼‰ |
| åŒæºç­–ç•¥ | é¡µé¢å’Œ API åŒ originï¼ˆå¦‚ `http://10.24.2.10:20080`ï¼‰ï¼Œæ—  CORS é—®é¢˜ |
| å¯¹è¯æ¨¡å¼ | **å§‹ç»ˆä½¿ç”¨ `stream: true`**ï¼ˆè§„é¿åç«¯éæµå¼ `NoneType` bugï¼‰ |
| å‰ç«¯æ¡†æ¶ | çº¯ HTML + CSS + Vanilla JSï¼ˆæ— æ„å»ºå·¥å…·ä¾èµ–ï¼Œæ–¹ä¾¿ç›´æ¥éƒ¨ç½²ï¼‰ |

---

## ä¸‰ã€å·²éªŒè¯å¯ç”¨çš„ API æ¥å£æ¸…å•

æ‰€æœ‰æ¥å£å‡é€šè¿‡ curl + æµè§ˆå™¨å®æµ‹éªŒè¯ï¼ŒBase URL ç¤ºä¾‹ï¼š`http://10.24.2.10:20080`

### 3.1 çŸ¥è¯†åº“ï¼ˆDatasetï¼‰

| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | å…³é”®å‚æ•° |
|------|------|------|----------|
| åˆ—è¡¨ | `GET` | `/api/v1/datasets?page=1&page_size=50` | Header: `Authorization: Bearer <key>` |
| åˆ›å»º | `POST` | `/api/v1/datasets` | Body: `{ name, description?, permission?, chunk_method? }` |
| åˆ é™¤ | `DELETE` | `/api/v1/datasets` | Body: `{ ids: ["id1", "id2"] }` |

### 3.2 æ–‡æ¡£ï¼ˆDocumentï¼‰

| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | å…³é”®å‚æ•° |
|------|------|------|----------|
| ä¸Šä¼  | `POST` | `/api/v1/datasets/{dataset_id}/documents` | FormData: `file`ï¼ˆmultipart/form-dataï¼‰|
| åˆ—è¡¨ | `GET` | `/api/v1/datasets/{dataset_id}/documents?page=1&page_size=50` | Header: Authorization |
| åˆ é™¤ | `DELETE` | `/api/v1/datasets/{dataset_id}/documents` | Body: `{ ids: ["doc_id1"] }` |
| è§¦å‘è§£æ | `POST` | `/api/v1/datasets/{dataset_id}/chunks` | Body: `{ document_ids: ["doc_id1"] }` |
| åœæ­¢è§£æ | `DELETE` | `/api/v1/datasets/{dataset_id}/chunks` | Body: `{ document_ids: ["doc_id1"] }` |

> ä¸Šä¼ å `run` çŠ¶æ€ä¸º `UNSTART`ï¼Œéœ€è¦æ˜¾å¼è°ƒç”¨"è§¦å‘è§£æ"æ¥å£ã€‚

### 3.3 ä¼šè¯ï¼ˆChat / Assistantï¼‰

| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | å…³é”®å‚æ•° |
|------|------|------|----------|
| åˆ›å»º | `POST` | `/api/v1/chats` | Body: `{ name, dataset_ids: ["id"] }` |
| åˆ—è¡¨ | `GET` | `/api/v1/chats` | Header: Authorization |
| åˆ é™¤ | `DELETE` | `/api/v1/chats` | Body: `{ ids: ["chat_id"] }` |

### 3.4 å¯¹è¯ï¼ˆOpenAI å…¼å®¹ï¼‰

| åŠŸèƒ½ | æ–¹æ³• | è·¯å¾„ | å…³é”®å‚æ•° |
|------|------|------|----------|
| èŠå¤© | `POST` | `/api/v1/chats_openai/{chat_id}/chat/completions` | Body: `{ model: "model", messages: [...], stream: true, extra_body?: { reference: true, reference_metadata: { include: true } } }` |

> **å¿…é¡»ä½¿ç”¨ `stream: true`**ï¼Œéæµå¼åˆ†æ”¯åœ¨ v0.23.1 å­˜åœ¨ bugã€‚

---

## å››ã€é¡µé¢å¸ƒå±€è®¾è®¡

é‡‡ç”¨**å·¦å³åˆ†æ  + é¡¶éƒ¨é…ç½®æ **çš„ç»å…¸å¸ƒå±€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¡¶éƒ¨æ ï¼šBase URL è¾“å…¥ | API Key è¾“å…¥ | è¿æ¥çŠ¶æ€æŒ‡ç¤ºç¯        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚                                             â”‚
â”‚  å·¦ä¾§é¢æ¿        â”‚  ä¸»å†…å®¹åŒº                                    â”‚
â”‚  (å¯æŠ˜å ,280px) â”‚                                             â”‚
â”‚                  â”‚  æ ¹æ®å·¦ä¾§é€‰ä¸­çš„ Tab åˆ‡æ¢ï¼š                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                             â”‚
â”‚  â”‚ ğŸ’¬ ä¼šè¯    â”‚ â”‚  Tab A: å¯¹è¯ç•Œé¢                             â”‚
â”‚  â”‚ ğŸ“š çŸ¥è¯†åº“  â”‚ â”‚  Tab B: çŸ¥è¯†åº“ & æ–‡æ¡£ç®¡ç†                     â”‚
â”‚  â”‚ âš™ï¸ è®¾ç½®   â”‚ â”‚                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                             â”‚
â”‚                  â”‚                                             â”‚
â”‚  ä¼šè¯ Tab:      â”‚                                             â”‚
â”‚  - ä¼šè¯åˆ—è¡¨     â”‚                                             â”‚
â”‚  - [+æ–°å»ºä¼šè¯]  â”‚                                             â”‚
â”‚                  â”‚                                             â”‚
â”‚  çŸ¥è¯†åº“ Tab:    â”‚                                             â”‚
â”‚  - çŸ¥è¯†åº“åˆ—è¡¨   â”‚                                             â”‚
â”‚  - [+æ–°å»ºçŸ¥è¯†åº“]â”‚                                             â”‚
â”‚                  â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åº•éƒ¨çŠ¶æ€æ ï¼šæ“ä½œæç¤º | ç‰ˆæœ¬ä¿¡æ¯                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.1 é¡¶éƒ¨é…ç½®æ 

- **Base URL è¾“å…¥æ¡†**ï¼šé»˜è®¤ `http://10.24.2.10:20080`ï¼Œæ”¯æŒä¿®æ”¹
- **API Key è¾“å…¥æ¡†**ï¼šå¯†ç æ ·å¼ï¼Œå¸¦æ˜¾ç¤º/éšè—åˆ‡æ¢
- **è¿æ¥æµ‹è¯•æŒ‰é’®**ï¼šç‚¹å‡»åè°ƒ `GET /api/v1/datasets` éªŒè¯è¿é€šæ€§
- **çŠ¶æ€æŒ‡ç¤ºç¯**ï¼šç»¿è‰² = å·²è¿æ¥ | çº¢è‰² = æœªè¿æ¥ | é»„è‰² = è¿æ¥ä¸­
- é…ç½®ä¿å­˜åˆ° `localStorage`ï¼Œä¸‹æ¬¡æ‰“å¼€è‡ªåŠ¨å¡«å……

### 4.2 å·¦ä¾§é¢æ¿ â€” ä¼šè¯ Tab

- **ä¼šè¯åˆ—è¡¨**ï¼š
  - æ¯é¡¹æ˜¾ç¤ºï¼šä¼šè¯åç§° + å…³è”çŸ¥è¯†åº“å
  - ç‚¹å‡»åˆ‡æ¢åˆ°è¯¥ä¼šè¯çš„å¯¹è¯ç•Œé¢
  - å³é”®æˆ–æ‚¬æµ®æŒ‰é’®ï¼šåˆ é™¤ä¼šè¯
- **æ–°å»ºä¼šè¯æŒ‰é’®**ï¼š
  - å¼¹å‡ºå°è¡¨å•ï¼šè¾“å…¥ä¼šè¯å + é€‰æ‹©å…³è”çŸ¥è¯†åº“ï¼ˆä¸‹æ‹‰å¤šé€‰ï¼‰
  - åˆ›å»ºåè‡ªåŠ¨åˆ‡æ¢åˆ°æ–°ä¼šè¯

### 4.3 å·¦ä¾§é¢æ¿ â€” çŸ¥è¯†åº“ Tab

- **çŸ¥è¯†åº“åˆ—è¡¨**ï¼š
  - æ¯é¡¹æ˜¾ç¤ºï¼šçŸ¥è¯†åº“å + æ–‡æ¡£æ•° + chunk æ•°
  - ç‚¹å‡»è¿›å…¥è¯¥çŸ¥è¯†åº“çš„æ–‡æ¡£ç®¡ç†è§†å›¾
  - å³é”®æˆ–æ‚¬æµ®æŒ‰é’®ï¼šåˆ é™¤çŸ¥è¯†åº“
- **æ–°å»ºçŸ¥è¯†åº“æŒ‰é’®**ï¼š
  - å¼¹å‡ºå°è¡¨å•ï¼šåç§° + æè¿° + åˆ‡åˆ†ç­–ç•¥é€‰æ‹©ï¼ˆnaive/paper/book/...ï¼‰

### 4.4 ä¸»å†…å®¹åŒº â€” å¯¹è¯ç•Œé¢ï¼ˆTab Aï¼‰

å½“å·¦ä¾§é€‰ä¸­æŸä¸ªä¼šè¯æ—¶æ˜¾ç¤ºï¼š

- **æ¶ˆæ¯åŒºåŸŸ**ï¼š
  - ç”¨æˆ·æ¶ˆæ¯å³å¯¹é½ï¼ˆè“è‰²æ°”æ³¡ï¼‰
  - åŠ©æ‰‹å›å¤å·¦å¯¹é½ï¼ˆç°è‰²æ°”æ³¡ï¼‰ï¼Œæµå¼æ‰“å­—æœºæ•ˆæœ
  - æ”¯æŒ Markdown æ¸²æŸ“ï¼ˆä»£ç å—ã€åˆ—è¡¨ã€åŠ ç²—ç­‰ï¼‰
- **å¼•ç”¨å±•ç¤º**ï¼š
  - æ¯æ¡å›å¤ä¸‹æ–¹å¯æŠ˜å çš„"å¼•ç”¨æ¥æº"åŒºåŸŸ
  - æ˜¾ç¤ºï¼šæ–‡æ¡£å + ç›¸ä¼¼åº¦åˆ†æ•° + å†…å®¹æ‘˜è¦
- **è¾“å…¥åŒºåŸŸ**ï¼š
  - å¤šè¡Œæ–‡æœ¬è¾“å…¥æ¡†
  - å‘é€æŒ‰é’®ï¼ˆEnter å‘é€ï¼ŒShift+Enter æ¢è¡Œï¼‰
  - æ¸…ç©ºå†å²æŒ‰é’®
- **è®¾ç½®åŒºåŸŸï¼ˆå¯æŠ˜å ï¼‰**ï¼š
  - ç³»ç»Ÿæç¤ºè¯ï¼ˆtextareaï¼‰
  - æ˜¯å¦æ£€ç´¢çŸ¥è¯†åº“ï¼ˆreference å¼€å…³ï¼‰
  - æ˜¯å¦æ˜¾ç¤ºå¼•ç”¨æ¥æºï¼ˆreference_metadata.include å¼€å…³ï¼‰

### 4.5 ä¸»å†…å®¹åŒº â€” çŸ¥è¯†åº“æ–‡æ¡£ç®¡ç†ï¼ˆTab Bï¼‰

å½“å·¦ä¾§é€‰ä¸­æŸä¸ªçŸ¥è¯†åº“æ—¶æ˜¾ç¤ºï¼š

- **çŸ¥è¯†åº“ä¿¡æ¯å¡ç‰‡**ï¼š
  - åç§°ã€æè¿°ã€embedding æ¨¡å‹ã€åˆ‡åˆ†ç­–ç•¥ã€æ–‡æ¡£æ•°ã€chunk æ•°
- **æ–‡æ¡£åˆ—è¡¨è¡¨æ ¼**ï¼š
  - åˆ—ï¼šæ–‡æ¡£å | å¤§å° | è§£æçŠ¶æ€ï¼ˆUNSTART/RUNNING/DONE/FAILï¼‰| ä¸Šä¼ æ—¶é—´ | æ“ä½œ
  - è§£æçŠ¶æ€ç”¨å½©è‰²æ ‡ç­¾å±•ç¤ºï¼š
    - `UNSTART` â†’ ç°è‰²
    - `RUNNING` â†’ è“è‰²ï¼ˆå¸¦åŠ¨ç”»ï¼‰
    - `DONE` â†’ ç»¿è‰²
    - `FAIL` â†’ çº¢è‰²
  - æ“ä½œåˆ—ï¼š[è§£æ] [åœæ­¢] [åˆ é™¤]
  - æ‰¹é‡æ“ä½œï¼šå…¨é€‰ + æ‰¹é‡è§£æ / æ‰¹é‡åˆ é™¤
  - è‡ªåŠ¨è½®è¯¢ï¼šå½“æœ‰æ–‡æ¡£å¤„äº `RUNNING` æ—¶ï¼Œæ¯ 5 ç§’åˆ·æ–°çŠ¶æ€
- **ä¸Šä¼ åŒºåŸŸ**ï¼š
  - æ‹–æ‹½ä¸Šä¼ åŒºï¼ˆdrag & dropï¼‰+ ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ï¼ˆæ”¯æŒå¤šé€‰ï¼‰
  - ä¸Šä¼ è¿›åº¦æ¡
  - ä¸Šä¼ å®Œæˆåè‡ªåŠ¨è§¦å‘è§£æ
  - æ”¯æŒçš„æ ¼å¼æç¤ºï¼šPDF / Word / TXT / Markdown / Excel / PPT / å›¾ç‰‡

---

## äº”ã€äº¤äº’ä½“éªŒè®¾è®¡

### 5.1 è§†è§‰é£æ ¼

- **æš—è‰²ä¸»é¢˜**ï¼ˆå»¶ç»­ä¹‹å‰ demo çš„é£æ ¼ï¼‰
- é…è‰²æ–¹æ¡ˆï¼š
  - èƒŒæ™¯ï¼š`#0f0f14`
  - å¡ç‰‡ï¼š`#18181f`
  - å¼ºè°ƒè‰²ï¼š`#6366f1`ï¼ˆé›è“ï¼‰
  - æˆåŠŸï¼š`#22c55e`
  - é”™è¯¯ï¼š`#ef4444`
  - æ–‡å­—ï¼š`#e4e4e9`
- å­—ä½“ï¼š`JetBrains Mono` / `SF Mono` / `Consolas`ï¼ˆç­‰å®½å­—ä½“ï¼‰
- åœ†è§’ + å¾®é˜´å½± + è¿‡æ¸¡åŠ¨ç”»

### 5.2 æ“ä½œåé¦ˆ

- æ‰€æœ‰æŒ‰é’®ç‚¹å‡»åç¦ç”¨ + loading åŠ¨ç”»ï¼Œé˜²æ­¢é‡å¤æäº¤
- æ“ä½œæˆåŠŸ / å¤±è´¥ â†’ Toast é€šçŸ¥ï¼ˆå³ä¸Šè§’ï¼Œè‡ªåŠ¨æ¶ˆå¤±ï¼‰
- åˆ é™¤æ“ä½œ â†’ äºŒæ¬¡ç¡®è®¤å¼¹çª—ï¼ˆ"ç¡®å®šè¦åˆ é™¤ xxx å—ï¼Ÿ"ï¼‰
- ç½‘ç»œé”™è¯¯ â†’ ç»Ÿä¸€é”™è¯¯æç¤ºï¼ˆ"è¯·æ±‚å¤±è´¥ï¼šxxx"ï¼‰

### 5.3 å¿«æ·æ“ä½œ

- `Enter` å‘é€æ¶ˆæ¯ï¼Œ`Shift+Enter` æ¢è¡Œ
- `Ctrl+K` èšç„¦æœç´¢æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰
- æ‹–æ‹½æ–‡ä»¶åˆ°é¡µé¢ä»»æ„ä½ç½®è§¦å‘ä¸Šä¼ 
- æ–‡ä»¶ä¸Šä¼ åè‡ªåŠ¨åˆ·æ–°æ–‡æ¡£åˆ—è¡¨ + è§¦å‘è§£æ

### 5.4 æ•°æ®æŒä¹…åŒ–ï¼ˆlocalStorageï¼‰

ä¿å­˜åˆ°æµè§ˆå™¨çš„æ•°æ®ï¼š
- Base URL + API Key
- ä¸Šæ¬¡é€‰ä¸­çš„çŸ¥è¯†åº“ ID
- ä¸Šæ¬¡é€‰ä¸­çš„ä¼šè¯ ID
- ç³»ç»Ÿæç¤ºè¯
- ç•Œé¢åå¥½ï¼ˆå·¦ä¾§é¢æ¿æ˜¯å¦æŠ˜å ç­‰ï¼‰

### 5.5 å“åº”å¼è®¾è®¡

- æ¡Œé¢ç«¯ï¼ˆ>= 1024pxï¼‰ï¼šå·¦å³åˆ†æ å¸ƒå±€
- å¹³æ¿ç«¯ï¼ˆ768px ~ 1024pxï¼‰ï¼šå·¦ä¾§é¢æ¿å¯æŠ˜å 
- ç§»åŠ¨ç«¯ï¼ˆ< 768pxï¼‰ï¼šåº•éƒ¨ Tab å¯¼èˆªï¼Œå…¨å±åˆ‡æ¢

---

## å…­ã€æ–‡ä»¶ç»“æ„

```
ragflow-webui/
â”œâ”€â”€ index.html          # å”¯ä¸€å…¥å£ï¼ŒåŒ…å«æ‰€æœ‰ HTML ç»“æ„
â”œâ”€â”€ style.css           # æ ·å¼ï¼ˆä¹Ÿå¯ä»¥å†…è”åœ¨ HTML é‡Œï¼‰
â””â”€â”€ app.js              # æ‰€æœ‰ JS é€»è¾‘ï¼ˆä¹Ÿå¯ä»¥å†…è”åœ¨ HTML é‡Œï¼‰
```

> å¦‚æœ agent å®ç°æ—¶æ›´æ–¹ä¾¿ï¼Œä¹Ÿå¯ä»¥å…¨éƒ¨å†™åœ¨ä¸€ä¸ª `index.html` é‡Œï¼ˆCSS + JS å†…è”ï¼‰ï¼Œ
> è¿™æ ·åªéœ€æŒ‚è½½ä¸€ä¸ªæ–‡ä»¶åˆ° Nginx å³å¯ã€‚

---

## ä¸ƒã€æ ¸å¿ƒ JS æ¨¡å—åˆ’åˆ†

```
app.js
â”œâ”€â”€ config.js           # é…ç½®ç®¡ç†ï¼ˆBase URL / API Key / localStorageï¼‰
â”œâ”€â”€ api.js              # æ‰€æœ‰ API è°ƒç”¨çš„å°è£…
â”‚   â”œâ”€â”€ datasets        # çŸ¥è¯†åº“ CRUD
â”‚   â”œâ”€â”€ documents       # æ–‡æ¡£ä¸Šä¼  / åˆ—è¡¨ / åˆ é™¤ / è§£æ
â”‚   â”œâ”€â”€ chats           # ä¼šè¯ CRUD
â”‚   â””â”€â”€ completion      # å¯¹è¯ï¼ˆSSE æµå¼ï¼‰
â”œâ”€â”€ ui.js               # UI æ¸²æŸ“ä¸äº¤äº’
â”‚   â”œâ”€â”€ sidebar         # å·¦ä¾§é¢æ¿ï¼ˆä¼šè¯åˆ—è¡¨ / çŸ¥è¯†åº“åˆ—è¡¨ï¼‰
â”‚   â”œâ”€â”€ chatView        # å¯¹è¯ç•Œé¢
â”‚   â”œâ”€â”€ docManager      # æ–‡æ¡£ç®¡ç†ç•Œé¢
â”‚   â”œâ”€â”€ toast           # æ¶ˆæ¯é€šçŸ¥
â”‚   â””â”€â”€ modal           # å¼¹çª—ï¼ˆåˆ›å»º / ç¡®è®¤åˆ é™¤ï¼‰
â””â”€â”€ utils.js            # å·¥å…·å‡½æ•°ï¼ˆæ ¼å¼åŒ–æ—¶é—´ / æ–‡ä»¶å¤§å°ç­‰ï¼‰
```

> å®é™…å®ç°æ—¶å¯ä»¥å…¨éƒ¨å†™åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œç”¨æ³¨é‡Šåˆ†åŒºå³å¯ã€‚

---

## å…«ã€API è°ƒç”¨å°è£…ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰

```javascript
// ç»Ÿä¸€è¯·æ±‚å‡½æ•°
async function apiCall(method, path, body, isFormData) {
  const url = `${getBaseUrl()}${path}`;
  const headers = { 'Authorization': `Bearer ${getApiKey()}` };
  if (!isFormData) headers['Content-Type'] = 'application/json';

  const options = { method, headers };
  if (body) {
    options.body = isFormData ? body : JSON.stringify(body);
  }

  const res = await fetch(url, options);
  const contentType = res.headers.get('content-type') || '';

  // å¦‚æœè¿”å› HTMLï¼ˆ502 ç­‰ï¼‰ï¼ŒæŠ›å‡ºå‹å¥½é”™è¯¯
  if (contentType.includes('text/html')) {
    throw new Error(`æœåŠ¡å™¨è¿”å› HTML é”™è¯¯é¡µï¼ˆHTTP ${res.status}ï¼‰ï¼Œè¯·æ£€æŸ¥åç«¯çŠ¶æ€`);
  }

  const json = await res.json();
  if (!res.ok || (json.code && json.code !== 0)) {
    throw new Error(json.message || `è¯·æ±‚å¤±è´¥ (HTTP ${res.status})`);
  }
  return json;
}

// æµå¼å¯¹è¯
async function* streamChat(chatId, messages, extraBody) {
  const url = `${getBaseUrl()}/api/v1/chats_openai/${chatId}/chat/completions`;
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getApiKey()}` },
    body: JSON.stringify({ model: 'model', messages, stream: true, extra_body: extraBody }),
  });

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop() || '';

    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed || !trimmed.startsWith('data:')) continue;
      const jsonStr = trimmed.replace(/^data:\s*/, '').trim();
      if (jsonStr === '[DONE]') return;
      try {
        yield JSON.parse(jsonStr);
      } catch {}
    }
  }
}
```

---

## ä¹ã€å…³é”®æ³¨æ„äº‹é¡¹

1. **å§‹ç»ˆç”¨ `stream: true` è°ƒå¯¹è¯æ¥å£**ï¼Œä¸è¦ç»™ç”¨æˆ·åˆ‡æ¢éæµå¼çš„é€‰é¡¹
2. **ä¸Šä¼ æ–‡ä»¶åå¿…é¡»æ˜¾å¼è§¦å‘è§£æ**ï¼ˆ`POST /api/v1/datasets/{id}/chunks`ï¼‰
3. **æ–‡æ¡£åˆ—è¡¨è½®è¯¢**ï¼šå½“æœ‰ `RUNNING` çŠ¶æ€æ–‡æ¡£æ—¶ï¼Œæ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°
4. **é”™è¯¯å…œåº•**ï¼šæ‰€æœ‰ fetch éƒ½è¦ try/catchï¼Œå¯¹ 502 / HTML å“åº”åšç‰¹æ®Šå¤„ç†
5. **localStorage å­˜æ•æ„Ÿä¿¡æ¯æ—¶æé†’ç”¨æˆ·**ï¼ˆAPI Key ä¼šä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼‰
6. **æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶**ï¼šNginx é»˜è®¤ `client_max_body_size 1024M`ï¼Œå‰ç«¯å¯æç¤º

---

## åã€å¼€å‘ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŠŸèƒ½æ¨¡å— | è¯´æ˜ |
|--------|---------|------|
| P0 | é…ç½®ç®¡ç† + è¿æ¥æµ‹è¯• | åŸºç¡€ï¼Œå…¶ä»–åŠŸèƒ½ä¾èµ– |
| P0 | çŸ¥è¯†åº“åˆ—è¡¨ + åˆ›å»º | å¯¹è¯å’Œä¸Šä¼ çš„å‰ç½®æ¡ä»¶ |
| P0 | å¯¹è¯åŠŸèƒ½ï¼ˆæµå¼ï¼‰ | æ ¸å¿ƒåŠŸèƒ½ |
| P0 | æ–‡æ¡£ä¸Šä¼  + è‡ªåŠ¨è§£æ | æ ¸å¿ƒåŠŸèƒ½ |
| P1 | æ–‡æ¡£åˆ—è¡¨ + çŠ¶æ€è½®è¯¢ | è®©ç”¨æˆ·çœ‹åˆ°è§£æè¿›åº¦ |
| P1 | ä¼šè¯åˆ—è¡¨ + åˆ‡æ¢ | å¤šä¼šè¯ç®¡ç† |
| P1 | åˆ é™¤æ“ä½œï¼ˆçŸ¥è¯†åº“/æ–‡æ¡£/ä¼šè¯ï¼‰| ç®¡ç†åŠŸèƒ½ |
| P2 | æ‹–æ‹½ä¸Šä¼  | ä½“éªŒä¼˜åŒ– |
| P2 | Markdown æ¸²æŸ“ | ä½“éªŒä¼˜åŒ– |
| P2 | å“åº”å¼å¸ƒå±€ | ç§»åŠ¨ç«¯é€‚é… |
| P2 | localStorage æŒä¹…åŒ– | ä½“éªŒä¼˜åŒ– |
| P3 | æ‰¹é‡æ“ä½œ | é«˜çº§åŠŸèƒ½ |
| P3 | å¿«æ·é”® | é«˜çº§åŠŸèƒ½ |
